/*
 * TouchScroll v1.0.1
 * By qiqiboy, http://www.qiqiboy.com, http://weibo.com/qiqiboy, 2012/04/06
 */
function TouchScroll(a){this.cfg=this.parseArgs(a),this.container="string"==typeof this.cfg.id?this.$(this.cfg.id):this.cfg.id;try{if(!this.container)throw new Error("Can't find element");for(var b=0,c=this.instances.length;c>b;b++)if(this.instances[b]==this.container)throw new Error("An instance has being running!");this.instances.push(this.container),this.setup()}catch(d){this.error=d.message}}TouchScroll.prototype={_default:{id:"slider",width:4,minLength:20,opacity:.8,onscroll:new Function,ondrag:new Function,color:"black",mouseAlign:1},instances:[],$:function(a){return document.getElementById(a)},$C:function(a,b){var c,d=document.createElement(a)||null;if(b="[object Object]"==Object.prototype.toString.call(b)?b:{},d)for(c in b)"style"==c?d.style.cssText+=b[c]:d.setAttribute(c,b[c]);return d},css:function(){var a=function(a){var b,c;switch(a){case"float":return"cssFloat"in document.body.style?"cssFloat":"styleFloat";case"opacity":return"opacity"in document.body.style?"opacity":{get:function(a,b){var c=b.filter;return c&&c.indexOf("opacity")>=0&&parseFloat(c.match(/opacity=([^)]*)/i)[1])/100+""||"1"},set:function(a,b){a.style.filter="alpha(opacity="+100*b+")",a.style.zoom=1}};default:for(b=a.split("-"),c=1;c<b.length;c++)b[c]=b[c].substring(0,1).toUpperCase()+b[c].substring(1);return a=b.join("")}},b=function(b,c){var d,e;return c=a(c),d=b.style[c],d||(e=document.defaultView&&document.defaultView.getComputedStyle&&getComputedStyle(b,null)||b.currentStyle||b.style,d="string"==typeof c?e[c]:c.get(b,e)),"auto"==d?"":d},c=function(b,c){var d,e;for(e in c)d=a(e),"string"==typeof d?b.style[d]=c[e]:d.set(b,c[e])};return function(a,d){return"string"==typeof d?b(a,d):c(a,d)}}(),parseArgs:function(a){var b,c={},d=Object.prototype.toString;if(a&&"[object Object]"==d.call(a))for(b in this._default)c[b]="undefined"==typeof a[b]?this._default[b]:"[object Number]"==d.call(this._default[b])?parseInt(100*parseFloat(a[b]))/100:a[b];else c=this._default;return c},addListener:function(a,b,c,d){return a.addEventListener?(a.addEventListener(b,c,d),!0):a.attachEvent?(a.attachEvent("on"+b,c),!0):!1},getPoint:function(a){a=a||window.event;var b=y=0,c=this.supportsTouches&&a.touches.length?a.touches[0]:a,d=document.documentElement,e=document.body;return window.pageXOffset?(b=window.pageXOffset,y=window.pageYOffset):(b=(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),y=(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),b+=c.clientX,y+=c.clientY,{x:b,y:y}},preventDefault:function(a){window.event?window.event.returnValue=!1:a.preventDefault()},contains:function(a,b){return a.contains?a!=b&&a.contains(b):!!(16&a.compareDocumentPosition(b))},bind:function(a,b){return function(){return a.apply(b,arguments)}},deleteAll:function(){for(var a=0;a<arguments.length;a++)delete this[arguments[a]]},fixedMouse:function(a,b){var c,d=a.type.toLowerCase();if("mouseover"==d)c=a.relatedTarget||a.fromElement;else{if(!(d="mouseout"))return!0;c=a.relatedTarget||a.toElement}return!c||"xul"!=c.prefix&&!this.contains(b,c)&&c!==b},setup:function(){var a=document.documentElement||document.getElementsByTagName("html")[0];this.supportsTouches="createTouch"in document||"ontouchstart"in window,this.supportsTransition="WebkitTransition"in a.style||"MsTransition"in a.style||"MozTransition"in a.style||"OTransition"in a.style||"transition"in a.style,this.startEvent=this.supportsTouches?"touchstart":"mousedown",this.moveEvent=this.supportsTouches?"touchmove":"mousemove",this.endEvent=this.supportsTouches?"touchend":"mouseup",this.overEvent=this.supportsTouches?"touchstart":"mouseover",this.outEvent=this.supportsTouches?"touchend":"mouseout",this.property=[["left","right","width","clientWidth","scrollWidth","horizontalBar","horizontalScrollBar"],["top","bottom","height","clientHeight","scrollHeight","verticalBar","verticalScrollBar"]],this.timer=[null,null],this.resize(),this.addListener(window,"resize",this.bind(function(){clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(this.bind(this.resize,this),100)},this),!1),this.addListener(document,this.moveEvent,this.bind(this.move,this),!1),this.addListener(document,this.endEvent,this.bind(this.end,this),!1),this.addListener(this.container,"touchcancel",this.bind(this.end,this),!1),this.addListener(this.container,this.overEvent,this.bind(this.toggleShow,this),!1),this.addListener(this.container,this.outEvent,this.bind(this.toggleShow,this),!1),this.addListener(this.container,"mousewheel",this.bind(this.mouseScroll,this),!1),this.addListener(this.container,"DOMMouseScroll",this.bind(this.mouseScroll,this),!1)},clear:function(){if(this.element){for(this.css(this.container,{visibility:"hidden"});this.element.childNodes.length;)this.container.appendChild(this.element.firstChild);this.container.removeChild(this.wrapper),this.container.scrollLeft=-this.ratio0*(this.container.scrollWidth-this.container.clientWidth),this.container.scrollTop=-this.ratio1*(this.container.scrollHeight-this.container.clientHeight),this.wrapper=this.element=this.horizontalBar=this.verticalBar=this.horizontalScrollBar=this.verticalScrollBar=null,this.css(this.container,{visibility:"visible"})}},resize:function(){var a,b,c,d,e,f;for(this.clear(),a=parseInt(this.css(this.container,"padding-left"))+parseInt(this.css(this.container,"padding-right")),b=parseInt(this.css(this.container,"padding-top"))+parseInt(this.css(this.container,"padding-bottom")),c=this.container.offsetWidth-(parseInt(this.css(this.container,"border-left-width"))||0)-(parseInt(this.css(this.container,"border-right-width"))||0)-this.container.clientWidth,d=this.container.offsetHeight-(parseInt(this.css(this.container,"border-top-width"))||0)-(parseInt(this.css(this.container,"border-bottom-width"))||0)-this.container.clientHeight,this.clientWidth=this.container.clientWidth-a+c,this.clientHeight=this.container.clientHeight-b+d,this.scrollWidth=this.container.scrollWidth-a,this.scrollHeight=this.container.scrollHeight-b,this.element=this.$C("div",{"class":"touchscrollelement",style:";overflow:hidden;width:"+this.scrollWidth+"px;padding:"+parseInt(d/2)+"px "+parseInt(c/2)+"px;position:absolute;top:-"+this.container.scrollTop+"px;left:-"+this.container.scrollLeft+"px;"}),this.wrapper=this.$C("div",{"class":"touchscrollwrapper",style:";overflow:hidden;position:relative;width:100%;height:"+this.clientHeight+"px;"});this.container.childNodes.length;)this.element.appendChild(this.container.firstChild);this.wrapper.appendChild(this.element),e=";opacity:0;filter:alpha(opacity=0);position:absolute;overflow:hidden;-webkit-transition:opacity 400ms ease-out;-moz-transition:opacity 400ms ease-out;-o-transition:opacity 400ms ease-out;-ms-transition:opacity 400ms ease-out;transition:opacity 400ms ease-out;",f=";position:absolute;width:100%;height:100%;top:0;left:0;background-color:"+this.cfg.color+";-webkit-border-radius:"+this.cfg.width+"px;-moz-border-radius:"+this.cfg.width+"px;border-radius:"+this.cfg.width+"px;",this.horizontalBar=this.$C("div",{"class":"touchscrollhorizontal",style:e}),this.verticalBar=this.$C("div",{"class":"touchscrollvertical",style:e}),this.horizontalScrollBar=this.$C("div",{"class":"touchscrollbar horizontal",style:f}),this.verticalScrollBar=this.$C("div",{"class":"touchscrollbar vertical",style:f}),this.horizontalBar.appendChild(this.horizontalScrollBar),this.verticalBar.appendChild(this.verticalScrollBar),this.wrapper.appendChild(this.horizontalBar),this.wrapper.appendChild(this.verticalBar),this.css(this.horizontalBar,{display:this.scrollWidth>this.clientWidth?"block":"none",width:this.clientWidth+"px",left:0,bottom:0,height:this.cfg.width+"px"}),this.css(this.verticalBar,{display:this.scrollHeight>this.clientHeight?"block":"none",height:this.clientHeight+"px",right:0,top:0,width:this.cfg.width+"px"}),this.container.appendChild(this.wrapper),this.scrollHeight=Math.max(this.scrollHeight,this.element.clientHeight),this.scrollWidth=Math.max(this.scrollWidth,this.element.clientWidth),this.refresh(0),this.refresh(1),this.addListener(this.wrapper,this.startEvent,this.bind(this.start,this),!1)},refresh:function(a,b){a=1*!!parseInt(a);var c,d,e,f,g,h,i,j,k,l;j=this[this.property[a][6]],c=this[this.property[a][4]],d=this[this.property[a][3]],e=Math.max(this.cfg.width,this.cfg.minLength),k=parseInt(this.css(this.element,this.property[a][0])),l=c==d?0:parseInt(1e3*(k/(c-d)))/1e3,f=Math.max(parseInt(d*d/c),e),k>0?(g=Math.max(this.cfg.width,f-k/d*f),h=0,i="auto"):d-c>=k?(g=Math.max(this.cfg.width,(c+k)/d*f),h="auto",i=0):(g=f,h=-k/(c-d||1)*(d-g)+"px",i="auto"),j.style[this.property[a][2]]=g+"px",j.style[this.property[a][0]]=h,j.style[this.property[a][1]]=i,this["ratio"+a]=l,b&&(this.css(this[this.property[a][5]],{opacity:this.cfg.opacity}),this.css(this[this.property[1-a][5]],{opacity:0})),this.cfg.onscroll.call(this,null)},toggleShow:function(a){if(a=a||window.event,this.wrapper&&(this.fixedMouse(a,this.container)||this.supportsTouches)){var b=a.type,c=0;switch(b){case this.overEvent:c=this.cfg.opacity,this.mouseEnter=!0;break;case this.outEvent:this.mouseEnter=!1;break;default:return!1}this.during||(this.css(this.horizontalBar,{opacity:c}),this.css(this.verticalBar,{opacity:c}))}},_scroll:function(a,b){var c,d,e,f,g,h,i,b,j=40;f=0,c=parseInt(this.css(this.element,this.property[a][0])),e=this[this.property[a][4]]-this[this.property[a][3]],d=c+b,d>0?d>j?(b=j-c,f=-j):f=-d:-e>d&&(-e-j>d?(b=-e-j-c,f=j):f=-e-d),g=400*Math.abs(b)/(Math.abs(b)+Math.abs(f)),i=function(){this.slide(a,f,400-g,"ease-in-out")},this.slide(a,b,g,h,i)},scroll:function(){for(var a=0;a<arguments.length;a++)this._scroll(a,arguments[a])},scrollTo:function(a,b){this.css(this.element,{left:-a+"px",top:-b+"px"}),this.refresh(0),this.refresh(1)},slide:function(a,b,c,d,e){function f(a,b,c,d,e){var f;switch(e){case"ease-in-out":f=(a/=d/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b;break;default:f=-c*((a=a/d-1)*a*a*a-1)+b}return f}function g(){b&&m>l?(l+=10,h.element.style[h.property[a][0]]=f(l,j,k,m,n)+"px",h.timer[a]=setTimeout(g,10),h.refresh(a,!0)):(h.during=!1,h.element.style[h.property[a][0]]=j+b+"px",h.mouseEnter||e||(h.css(h.horizontalBar,{opacity:0}),h.css(h.verticalBar,{opacity:0})),h.refresh(a),i.call(h,null)),h.deleteAll("timer"+a)}var h=this,i=e||new Function,j=parseInt(this.css(this.element,this.property[a][0])),k=b,l=0,m=c||400,n=d||"ease-out";this.during=!0,clearTimeout(this.timer[a]),g()},start:function(a){clearTimeout(this.timer[0]),clearTimeout(this.timer[1]),this.supportsTouches||this.preventDefault(a),this.element.onclick=null;var b=a&&a.target||window.event.srcElement;3==b.nodeType&&(b=b.parentNode),this.target=b==this.wrapper||b==this.element||this.contains(this.element,b)?0:1,this.startPos=this.getPoint(a),this.elementRect=[parseInt(this.css(this.element,"left")),parseInt(this.css(this.element,"top"))],this.disc=[[new Date],[this.startPos]]},move:function(a){var b,c,d,e,f;!this.disc||a.touches&&a.touches.length>1||a.scale&&1!==a.scale||(this.endPos=this.getPoint(a),d=[this.endPos.x-this.startPos.x,this.endPos.y-this.startPos.y],e=1,"undefined"==typeof this.flag&&(this.flag=this.scrollWidth>this.clientWidth&&Math.abs(d[0])>=Math.abs(d[1])?0:this.scrollHeight>this.clientHeight&&Math.abs(d[1])>=Math.abs(d[0])?1:!1),this.flag!==!1&&(this.preventDefault(a),this.during=!0,c=this[this.property[this.flag][4]]-this[this.property[this.flag][3]],this.target&&(f=parseInt(this.css(this[this.property[this.flag][6]],this.property[this.flag][2])),e=-c/(this[this.property[this.flag][3]]-f)),b=this.elementRect[this.flag]+d[this.flag]*e,b>0?b/=b/this[this.property[this.flag][3]]+1:-c>b&&(b+=c,b=b/(Math.abs(b)/this[this.property[this.flag][3]]+1)-c),this.element.style[this.property[this.flag][0]]=b+"px",this.refresh(this.flag,!0),this.disc[0].push(new Date),this.disc[1].push(this.endPos)))},end:function(){if(this.disc){if("number"==typeof this.flag){var a,b,c,d,e,f,g;if(a=0,g=this[this.property[this.flag][4]]-this[this.property[this.flag][3]],b=parseInt(this.css(this.element,this.property[this.flag][0])),b>0)a=-b;else if(-g>b)a=-g-b;else if(!this.target){for(c=new Date;this.disc[0].length&&c-this.disc[0][0]>200;)this.disc[0].shift(),this.disc[1].shift();this.disc[0].length&&(f=c-this.disc[0][0],d=[this.endPos.x-this.disc[1][0].x,this.endPos.y-this.disc[1][0].y],e=d[this.flag],Math.abs(e)>20&&(a=(2-f/200)*e))}this.cfg.ondrag.call(this,this.flag,a)!==!1&&this._scroll(this.flag,a),this.element.onclick=new Function("return false;")}this.deleteAll("startPos","endPos","disc","flag","target","elementRect")}},mouseScroll:function(a){this.preventDefault(a),a=a||window.event;var b,c=a.wheelDelta||a.detail&&-1*a.detail||0,d=120,e=this.cfg.mouseAlign;this.wrapper&&c&&(b=c/Math.abs(c),this._scroll(e,b*d))}},window.TouchScroll=TouchScroll;